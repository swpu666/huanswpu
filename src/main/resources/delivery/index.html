<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no,minimal-ui">
  <title>首页</title>
  <link rel="icon" href="images/swpu.ico">
  <!--不同屏幕尺寸根字体设置-->
  <script src="js/base.js"></script>
  <!--element-ui的样式-->
  <link rel="stylesheet" href="../backend/plugins/element-ui/index.css" />
  <!--引入vant样式-->
  <link rel="stylesheet" href="styles/vant.min.css"/>
  <!-- 引入样式  -->
  <link rel="stylesheet" href="styles/index.css" />
  <!--本页面内容的样式-->
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body style="max-width: 400px">
<div id="main" class="app">
  <div class="common-layout">
    <el-container>
      <el-header height="20%" width="100%" style="padding: 0;position: absolute;width: 100%">
        <div class="divHead">
          <h3 style="color: white; text-align: center;padding-top: 10px;">订单中心</h3>
        <img src="images/user.png" @click="toUserPage"/>
        </div>
    </el-header>
      <el-main style="max-width: 400px;top:20%;width: 100%; height: 70%;position: absolute;">
        <el-card class="box-card" style="margin-bottom: 30px;">
          <template #header>
            <div class="card-header">
              <span style="font-size: 15px;">距离：10km</span>
              <span style="font-size: 15px; color: red;float: right;">￥:8</span>
            </div>
          </template>
          <div style="font-size: 15px;">
          <span style="color: green;">取:</span>
          <span>正因村12街97号德玛西亚三汁焖锅店(石油大学店)</span>
        </div>
        <div style="font-size: 15px; margin-top: 15px;">
          <span style="margin-top: 10px; color: rgb(0, 145, 255);">送:</span>
          <span >西南石油大学成都校区15栋寝室</span><br>
        </div>
        <div style="font-size: 15px; margin-top: 15px;">
          <span style="margin-top: 10px; color: red;">顾客电话:</span>
          <span >15386614967</span><br>
        </div>
        <el-button type="primary" style="width: 100%; margin-top: 15px;height: 30px; padding-top:7px;">抢单</el-button>
        </el-card>

      

        <el-card class="box-card" v-for="(item,index) of orderInfo"  style="margin-bottom: 30px;">
          <template #header>
            <div class="card-header">
              <span style="font-size: 15px;">点餐时间：{{item.orderTime}}</span>
              <span style="font-size: 15px; color: red;float: right;">￥:{{item.amount}}</span>
            </div>
          </template>
          <div style="font-size: 15px;">
          <span style="color: green;">取:</span>
          <span>{{item.employeeAddress}}</span>
        </div>
        <div style="font-size: 15px; margin-top: 15px;">
          <span style="margin-top: 10px; color: rgb(0, 145, 255);">送:</span>
          <span >{{item.userAddress}}</span><br>
        </div>
        <div style="font-size: 15px; margin-top: 15px;">
          <span style="margin-top: 10px; color: red;">顾客电话:</span>
          <span >15386614967</span><br>
        </div>
        <el-button type="primary" style="width: 100%; margin-top: 15px;height: 30px; padding-top:7px;">抢单</el-button>
        </el-card>

      </el-main>
      <el-footer height="10%" style="border-top:gray solid 1px; position: absolute;bottom: 0;width: 100%;">
        <div style="cursor: pointer; margin-top: 15px; margin-left: 50px; display: inline-block;text-align: center;">
          <img src="./images/订单.png" style="user-select: none;width:30px ;height: 30px;" alt="">
         <p style="color: rgb(0, 145, 255);margin-top: 5px; font-size: 16px;user-select: none; font-family: '宋体';">我要接单</p>
        </div>
        <div @click="toUserPage" style="cursor: pointer; margin-top: 15px; margin-left: 100px; display: inline-block;text-align: center;">
          <img src="./images/_我的.png" style="user-select: none;width:30px ;height: 30px;" alt="">
         <p style="margin-top: 5px; user-select: none;font-size: 16px; font-family: '宋体';">个人中心</p>
        </div>
      </el-footer>
    </el-container>
  </div>


<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="../backend/plugins/vue/vue.js"></script>
<!-- 引入组件库 -->
<script src="../backend/plugins/element-ui/index.js"></script>
<!-- 引入vant样式 -->
<script src="js/vant.min.js"></script>
<!-- 引入axios -->
<script src="../backend/plugins/axios/axios.min.js"></script>
<script src="js/request.js"></script>
<script src="js/common.js"></script>
<script src="api/main.js"></script>
<script src="api/order.js"></script>
</body>
<script>
  new Vue({
    el:'#main',
    data(){
      return {
        //左边菜品类别index
        activeType:0,
        categoryList:[],
        categoryId:undefined,
        orderInfo:[],
        dishList:[],
        cartData:[],
        dialogFlavor:{
          name:'',
          flavors:[],
          dishId:undefined,
          price:undefined,
          show:false,
          image:''
        },
        cartDialogShow:false,
        detailsDialog:{
          show:false,
          item:{image:''}
        },
        setMealDialog:{
          show:false,
          item:{}
        },
      }
    },
    computed:{
      goodsNum(){
        let num = 0
        this.cartData.forEach(item=>{
          num += item.number
        })
        if(num <99){
          return num
        }else{
          return '99+'
        }
      },
      goodsPrice(){
        let price = 0
        this.cartData.forEach(item=>{
          price += (item.number * item.amount)
        })
        return price
      }
    },
    created(){
    },
    watch:{
      'dialogFlavor.show'(flag){
        if(flag){
          document.querySelector('.divCart').style.zIndex = 1
        }else{
          document.querySelector('.divCart').style.zIndex = 3000
        }
      },
    },
    mounted(){
      this.initData()
    },
    methods:{
      //初始化数据
      async initData(){
          const res = await orderReceive();
          if(res.code === 1){
           this.orderInfo = res.data
           console.log(orderInfo)
          }else{
            this.$notify({ type:'warning', message:res[0].msg});
          }
        },
      //分类点击
      categoryClick(index,id,type){
        this.activeType = index
        this.categoryId = id
        if(type === 1){//菜品
          this.getDishList()
        }else{
          this.getSetmealData()
        }
      },
      //获取菜品数据
      async getDishList(){
        if(!this.categoryId){
          return
        }
        const res = await dishListApi({categoryId:this.categoryId,status:1})
        if(res.code === 1){
          let dishList = res.data
          const cartData  = this.cartData
          if(dishList.length > 0 && cartData.length > 0){
            dishList.forEach(dish=>{
              cartData.forEach(cart=>{
                if(dish.id === cart.dishId){
                  dish.number = cart.number
                }
              })
            })
          }
          this.dishList = dishList
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },
      //获取套餐数据setmealId
      async getSetmealData(){
        if(!this.categoryId){
          return
        }
        const res = await setmealListApi({categoryId:this.categoryId,status:1})
        if(res.code === 1){
          let dishList = res.data
          const cartData  = this.cartData
          if(dishList.length > 0 && cartData.length > 0){
            dishList.forEach(dish=>{
              cartData.forEach(cart=>{
                if(dish.id === cart.setmealId){
                  dish.number = cart.number
                }
              })
            })
          }
          this.dishList = dishList
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },
      //获取购物车数据
      async getCartData(){
        const res = await cartListApi({})
        if(res.code === 1){
          this.cartData = res.data
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },
      //菜单中往购物车中添加商品
      async addCart(item){
        let params = {
          amount:item.price/100,//金额
          dishFlavor:item.dishFlavor,//口味  如果没有传undefined
          dishId:undefined,//菜品id
          setmealId:undefined,//套餐id
          name:item.name,
          image:item.image
        }
        if(Array.isArray(item.flavors)){//表示是菜品
          params.dishId = item.id
        }else{//表示套餐 套餐没有口味
          params.setmealId = item.id
        }
        const res = await addCartApi(params)
        if(res.code === 1){
          this.dishList.forEach(dish=>{
            if(dish.id === item.id){
              dish.number = res.data.number
            }
          })
          if(this.setMealDialog.show){
            item.number = res.data.number
          }
          this.getCartData()
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },

      //菜单中减少选中的商品
      async subtractCart(item){
        let params = {
          dishId:item.id,
        }
        if(!Array.isArray(item.flavors)){
          params = {
            setmealId:item.id,
          }
        }
        const res = await updateCartApi(params)
        if(res.code === 1){
          this.dishList.forEach(dish=>{
            if(dish.id === item.id){
              dish.number = (res.data.number === 0 ? undefined : res.data.number)
            }
          })
          if(this.setMealDialog.show){
            item.number = (res.data.number === 0 ? undefined : res.data.number)
          }
          this.getCartData()
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },

      //展开购物车
      openCart(){
        if(this.cartData.length > 0){
          this.cartDialogShow = true
        }
      },
      //购物车中增加商品数量
      async cartNumAdd(item){
        let params = {
          amount:item.amount,//金额
          dishFlavor:item.dishFlavor,//口味  如果没有传undefined
          dishId:item.dishId,//菜品id
          setmealId:item.setmealId,//套餐id
          name:item.name,
          image:item.image
        }
        const res = await addCartApi(params)
        if(res.code === 1){
          this.dishList.forEach(dish=>{
            if(dish.id === (item.dishId || item.setmealId)){
              dish.number = res.data.number
            }
          })
          console.log(this.dishList)
          this.getCartData()
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },
      //购物车中减少商品数量
      async cartNumberSubtract(item){
        let params = {
          dishId:item.dishId,
          setmealId:item.setmealId,
        }
        const res = await updateCartApi(params)
        if(res.code === 1){
          this.dishList.forEach(dish=>{
            if(dish.id === (item.dishId || item.setmealId)){
              dish.number = (res.data.number === 0 ? undefined : res.data.number)
            }
          })
          this.getCartData()
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },

      //修改商品列表中的数据number
      changeDishList(item){
        for(let ele of this.dishList){
          if(ele.id === (item.setmealId || item.dishId)){
            ele.number = item.number
          }
        }
      },

      //清空购物车
      async clearCart(){
        const res = await clearCartApi()
        if(res.code === 1){
          for(let ele of this.dishList){
            ele.number = undefined
          }
          this.cartData = []
          this.cartDialogShow = false
        }else{
          this.$notify({ type:'warning', message:res.msg});
        }
      },
      //点击选择规格
      chooseFlavorClick(item){
        this.dialogFlavor = {
          name:'',
          flavors:[],
          dishId:undefined,
          price:undefined,
          show:false
        }
        this.dialogFlavor={
          name:item.name,
          flavors:item.flavors,
          dishId:item.id,
          price:item.price,
          show:true,
          image:item.image
        }
      },
      flavorClick(flavor,item){
        flavor.dishFlavor = item
        //强制刷新dialog的dom
        this.dialogFlavor.show = false
        this.dialogFlavor.show = true
      },
      //选择规格加入购物车
      dialogFlavorAddCart(){
        const dialogFlavor = this.dialogFlavor
        let flag = true
        let dishFlavor = []
        dialogFlavor.flavors.forEach(item=>{
          if(item.dishFlavor){
            dishFlavor.push(item.dishFlavor)
          }else{
            flag = false
            Notify({ type: 'warning', message: '请选择'+ item.name });
          }
        })
        if(flag){
          this.addCart({
            price:dialogFlavor.price,
            dishFlavor:dishFlavor.join(","),
            id:dialogFlavor.dishId,
            flavors:[],
            image:dialogFlavor.image,
            name:dialogFlavor.name
          })
          this.dialogFlavor.show = false
        }

      },
      //网络图片路径转换
      imgPathConvert(path){
        return imgPath(path)
      },
      //跳转到去结算界面
      toAddOrderPage(){
        if(this.cartData.length > 0){
          window.requestAnimationFrame(()=>{
            window.location.href ='/front/page/add-order.html'
          })
        }
      },
      toUserPage(){
        window.requestAnimationFrame(()=>{
          window.location.href= '/delivery/page/user.html'
        })
      },
      async dishDetails(item){
        //先清除对象数据，如果不行的话dialog使用v-if
        this.detailsDialog.item = {}
        this.setMealDialog.item = {}
        if(Array.isArray(item.flavors)){
          this.detailsDialog.item = item
          this.detailsDialog.show = true
        }else{
          //显示套餐的数据
          const res = await setMealDishDetailsApi(item.id)
          if(res.code === 1){
            this.setMealDialog.item = {...item,list:res.data}
            this.setMealDialog.show = true
          }else{
            this.$notify({ type:'warning', message:res.msg});
          }
        }

      }

    }
  })
</script>
</html>
